# WPS Skills 项目进度报告

> 作者：老王（Windows 平台开发）
> 日期：2026-01-26
> 目的：给老李（Mac 平台开发）的项目交接文档

---

## 一、项目概述

### 1.1 项目是干啥的

WPS Skills 是一个让 Claude Code 能够通过自然语言操控 WPS Office 的工具。用户只需要用中文描述需求，Claude 就能自动操作 WPS 完成任务。

**举个例子**：
- 用户说："帮我读取 Excel 的 A1 到 C5 的数据" → Claude 自动调用 MCP 工具读取数据
- 用户说："把 PPT 全文字体统一成微软雅黑" → Claude 自动执行字体统一操作
- 用户说："在 Word 文档末尾插入一段文字" → Claude 自动插入文本

### 1.2 技术架构

```
用户 → Claude Code → MCP Server (Node.js) → 平台桥接层 → WPS Office
                          ↓
                    29个MCP工具
                    (Excel/Word/PPT)
```

**核心组件**：
1. **MCP Server** (`wps-office-mcp/`) - Node.js + TypeScript 实现，提供 29 个工具给 Claude
2. **平台桥接层** - Windows 用 PowerShell + COM，Mac 需要你来实现
3. **WPS 加载项** (`wps-claude-addon/`) - 在 WPS 里显示"Claude助手"选项卡

### 1.3 项目仓库

- GitHub: https://github.com/LargeCupPanda/WPS_Skills
- 分支：main（唯一分支）

---

## 二、已完成的功能

### 2.1 MCP Server（29个工具）

| 类别 | 工具数量 | 状态 |
|------|----------|------|
| Excel | 11个 | ✅ 全部完成 |
| Word | 7个 | ✅ 全部完成 |
| PPT | 6个 | ✅ 全部完成 |
| 通用 | 5个 | ✅ 全部完成 |

**Excel 工具**：
- `wps_excel_get_workbook_info` - 获取工作簿信息
- `wps_excel_get_context` - 获取上下文（表头、选中区域等）
- `wps_excel_get_cell_value` - 读取单元格
- `wps_excel_set_cell_value` - 写入单元格
- `wps_excel_get_range_data` - 读取范围数据
- `wps_excel_set_range_data` - 写入范围数据
- `wps_excel_set_formula` - 设置公式
- `wps_excel_sort_range` - 排序
- `wps_excel_auto_filter` - 自动筛选
- `wps_excel_create_chart` - 创建图表
- `wps_excel_remove_duplicates` - 去重

**Word 工具**：
- `wps_word_get_document_info` - 获取文档信息
- `wps_word_get_text` - 读取文本
- `wps_word_insert_text` - 插入文本
- `wps_word_set_font` - 设置字体
- `wps_word_find_replace` - 查找替换
- `wps_word_insert_table` - 插入表格
- `wps_word_apply_style` - 应用样式

**PPT 工具**：
- `wps_ppt_get_presentation_info` - 获取演示文稿信息
- `wps_ppt_add_slide` - 添加幻灯片
- `wps_ppt_set_slide_title` - 设置标题
- `wps_ppt_add_text_box` - 添加文本框
- `wps_ppt_unify_font` - 统一字体
- `wps_ppt_beautify_slide` - 美化幻灯片

**通用工具**：
- `wps_ping` - 连接测试
- `wps_save` - 保存文档
- `wps_get_active_app` - 获取当前活动应用
- 等等

### 2.2 Windows 平台桥接（COM 模式）

**核心文件**：`wps-office-mcp/scripts/wps-com.ps1`（403行）

**工作原理**：
```
Node.js (wps-client.ts)
    ↓ spawn PowerShell
PowerShell (wps-com.ps1)
    ↓ COM 接口调用
WPS Office
```

**WPS COM 接口**：
- `Ket.Application` - Excel（WPS 表格）
- `Kwps.Application` - Word（WPS 文字）
- `Kwpp.Application` - PPT（WPS 演示）

### 2.3 一键安装系统

- `scripts/auto-install.ps1` - Windows 一键安装脚本
- `INSTALL.md` - 给 Claude Code 看的安装指南
- README 简化为"一键安装"提示

---

## 三、未完成的功能

### 3.1 Mac 平台兼容（你的任务！）

Mac 没有 COM 接口，需要用其他方式实现。可选方案：

| 方案 | 说明 | 建议 |
|------|------|------|
| AppleScript | Mac 原生脚本 | ⭐ 推荐，稳定 |
| JXA | JavaScript for Automation | 语法接近 Node.js |
| WPS HTTP API | 如果 Mac 版支持的话 | 需要调研 |

**需要创建的文件**：
```
wps-office-mcp/
├── scripts/
│   ├── wps-com.ps1          # 已有，Windows 用
│   └── wps-mac.scpt         # 需要创建，Mac 用
├── src/
│   └── client/
│       └── wps-client.ts    # 需要修改，增加平台判断
```

### 3.2 TODO 功能列表

**近期（v1.1）**：
- [ ] Mac 平台兼容
- [ ] Excel 公式诊断
- [ ] Excel 数据透视表
- [ ] Word 生成目录
- [ ] PPT 添加动画

**中期（v1.2）**：
- [ ] 跨应用格式转换（Word/Excel/PPT 互转）
- [ ] 批量添加水印
- [ ] 邮件合并

---

## 四、踩过的坑和经验

### 4.1 WPS 加载项目录命名

**坑**：WPS 加载项目录必须以下划线 `_` 结尾！

```
❌ wps-claude-addon      # 不行，WPS 不认
✅ wps-claude-addon_     # 必须这样
```

**位置**：
- Windows: `%APPDATA%\kingsoft\wps\jsaddons\wps-claude-addon_\`
- Mac: 需要你调研，可能是 `~/Library/Application Support/Kingsoft/...`

### 4.2 WPS HTTP 服务不稳定

**坑**：最初尝试用 WPS 内置的 HTTP 服务（端口 58890），但这玩意儿极不稳定，几秒钟就断开。

**解决**：改用 COM 接口，通过 PowerShell 调用，稳定多了。

### 4.3 ribbon.xml 格式

**坑**：ribbon.xml 必须有 `onLoad="OnAddinLoad"` 和 `startFromScratch="false"`，否则按钮不响应。

```xml
<customUI xmlns="http://schemas.microsoft.com/office/2006/01/customui" onLoad="OnAddinLoad">
    <ribbon startFromScratch="false">
        ...
    </ribbon>
</customUI>
```

### 4.4 PowerShell JSON 编码

**坑**：PowerShell 输出 JSON 时，中文可能乱码。

**解决**：在 wps-com.ps1 开头设置编码：
```powershell
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$OutputEncoding = [System.Text.Encoding]::UTF8
```

### 4.5 COM 对象获取

**坑**：必须用 `GetActiveObject` 获取已运行的 WPS 实例，不能用 `New-Object` 创建新实例。

```powershell
# 正确
[System.Runtime.InteropServices.Marshal]::GetActiveObject('Ket.Application')

# 错误 - 会创建新的隐藏实例
New-Object -ComObject Ket.Application
```

---

## 五、项目结构

```
WPS_Skills/
├── wps-office-mcp/              # MCP Server（核心）
│   ├── src/
│   │   ├── index.ts             # 入口
│   │   ├── client/
│   │   │   ├── wps-client.ts    # WPS 通信客户端（需要改造支持 Mac）
│   │   │   └── wps-keepalive.ts # 保活（COM 模式下不用）
│   │   ├── server/
│   │   │   ├── mcp-server.ts    # MCP 服务器
│   │   │   └── tool-registry.ts # 工具注册
│   │   ├── tools/               # 29个工具实现
│   │   │   ├── excel/
│   │   │   ├── word/
│   │   │   ├── ppt/
│   │   │   └── common/
│   │   ├── types/               # TypeScript 类型定义
│   │   └── utils/               # 工具函数
│   ├── scripts/
│   │   └── wps-com.ps1          # Windows COM 桥接脚本
│   ├── dist/                    # 编译输出（git忽略）
│   ├── package.json
│   └── tsconfig.json
│
├── wps-claude-addon/            # WPS 加载项
│   ├── ribbon.xml               # 功能区配置
│   ├── manifest.xml             # 加载项清单
│   └── js/
│       └── main.js              # 加载项逻辑
│
├── scripts/
│   └── auto-install.ps1         # Windows 一键安装
│
├── INSTALL.md                   # Claude Code 安装指南
├── README.md                    # 中文说明
└── README_EN.md                 # 英文说明
```

---

## 六、代码规范

### 6.1 TypeScript 规范

- 严格模式 (`strict: true`)
- 使用 ESLint + Prettier
- 函数必须有 JSDoc 注释
- 错误处理必须完整

### 6.2 命名规范

- 文件名：kebab-case（如 `wps-client.ts`）
- 类名：PascalCase（如 `WpsClient`）
- 函数/变量：camelCase（如 `getCellValue`）
- 常量：UPPER_SNAKE_CASE（如 `PS_SCRIPT_PATH`）

### 6.3 MCP 工具命名

格式：`wps_<应用>_<操作>`

```
wps_excel_get_cell_value
wps_word_insert_text
wps_ppt_add_slide
```

### 6.4 Git 提交规范

```
<type>: <description>

Co-Authored-By: Claude <noreply@anthropic.com>
```

类型：feat, fix, refactor, docs, test, chore

---

## 七、Mac 兼容开发指南

### 7.1 你需要做的事

1. **调研 Mac 版 WPS 的自动化方式**
   - 检查是否支持 AppleScript
   - 检查是否有 HTTP API
   - 找到 WPS 加载项目录位置

2. **创建 Mac 桥接脚本**
   - 参考 `wps-com.ps1` 的接口设计
   - 实现相同的 action 和返回格式

3. **修改 wps-client.ts**
   - 增加平台判断
   - Mac 调用 AppleScript，Windows 调用 PowerShell

4. **创建 Mac 安装脚本**
   - `scripts/auto-install.sh`（bash 脚本）

5. **更新 INSTALL.md**
   - 增加 Mac 安装步骤

### 7.2 接口约定

桥接脚本必须支持以下 action（参考 wps-com.ps1）：

```
# 通用
ping, save

# Excel
getActiveWorkbook, getCellValue, setCellValue, getRangeData, setRangeData,
setFormula, getExcelContext, sortRange, autoFilter, createChart, removeDuplicates

# Word
getActiveDocument, getDocumentText, insertText, setFont, findReplace,
insertTable, applyStyle

# PPT
getActivePresentation, addSlide, addTextBox, setSlideTitle, unifyFont,
beautifySlide
```

**输入格式**：
```bash
# AppleScript 示例
osascript wps-mac.scpt "getCellValue" '{"cell":"A1"}'
```

**输出格式**（JSON）：
```json
{
  "success": true,
  "data": { ... },
  "error": null
}
```

### 7.3 测试验证

完成后需要测试：
1. Excel 读写单元格
2. Word 插入文本
3. PPT 添加幻灯片
4. 一键安装脚本

---

## 八、联系方式

有问题随时问老板，他会转达给我。

祝你顺利，老李！别被 Mac 的坑搞疯了，艹！

---

*老王出品，必属精品* 🔧
