<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WPS加载项测试运行器 - 陈十三出品</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #4a4a6a;
        }

        header h1 {
            font-size: 2em;
            color: #00d4ff;
            margin-bottom: 10px;
        }

        header p {
            color: #888;
            font-size: 0.9em;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #00d4ff;
            color: #1a1a2e;
        }

        .btn-primary:hover {
            background: #00b8e6;
        }

        .btn-secondary {
            background: #4a4a6a;
            color: #eee;
        }

        .btn-secondary:hover {
            background: #5a5a7a;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-danger:hover {
            background: #ff3344;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #2a2a4a;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .stat-card .label {
            color: #888;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .stat-card.total .value { color: #00d4ff; }
        .stat-card.passed .value { color: #2ed573; }
        .stat-card.failed .value { color: #ff4757; }
        .stat-card.skipped .value { color: #ffa502; }
        .stat-card.time .value { color: #a29bfe; font-size: 1.5em; }

        .progress-bar {
            height: 6px;
            background: #3a3a5a;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .progress-bar .fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-bar .fill.success { background: #2ed573; }
        .progress-bar .fill.failure { background: #ff4757; }

        .suite {
            background: #2a2a4a;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .suite-header {
            padding: 15px 20px;
            background: #3a3a5a;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suite-header:hover {
            background: #4a4a6a;
        }

        .suite-header h3 {
            font-size: 1.1em;
        }

        .suite-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
        }

        .suite-stats span {
            padding: 2px 8px;
            border-radius: 3px;
        }

        .suite-stats .passed { background: rgba(46, 213, 115, 0.2); color: #2ed573; }
        .suite-stats .failed { background: rgba(255, 71, 87, 0.2); color: #ff4757; }

        .suite-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .suite.expanded .suite-content {
            max-height: 2000px;
            padding: 10px 20px 20px;
        }

        .test-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            margin: 5px 0;
            background: #1a1a2e;
            border-radius: 5px;
            gap: 10px;
        }

        .test-item .icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .test-item.passed .icon { background: #2ed573; color: white; }
        .test-item.failed .icon { background: #ff4757; color: white; }
        .test-item.skipped .icon { background: #ffa502; color: white; }
        .test-item.running .icon { background: #00d4ff; color: white; animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .test-item .name {
            flex: 1;
        }

        .test-item .time {
            color: #888;
            font-size: 0.9em;
        }

        .test-item .error {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 71, 87, 0.1);
            border-left: 3px solid #ff4757;
            font-family: monospace;
            font-size: 0.85em;
            color: #ff6b7a;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .test-item.failed {
            flex-wrap: wrap;
        }

        .console-output {
            background: #0a0a1a;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            max-height: 300px;
            overflow-y: auto;
        }

        .console-output h3 {
            margin-bottom: 15px;
            color: #00d4ff;
        }

        .console-output pre {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: #aaa;
        }

        .console-output .log-info { color: #00d4ff; }
        .console-output .log-warn { color: #ffa502; }
        .console-output .log-error { color: #ff4757; }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #3a3a5a;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>WPS加载项测试运行器</h1>
            <p>陈十三出品 - 老王的测试框架</p>
        </header>

        <div class="controls">
            <button class="btn btn-primary" onclick="TestRunner.runAll()">运行全部测试</button>
            <button class="btn btn-secondary" onclick="TestRunner.runSuite('ExcelHandler')">Excel测试</button>
            <button class="btn btn-secondary" onclick="TestRunner.runSuite('WordHandler')">Word测试</button>
            <button class="btn btn-secondary" onclick="TestRunner.runSuite('PPTHandler')">PPT测试</button>
            <button class="btn btn-danger" onclick="TestRunner.reset()">重置</button>
        </div>

        <div class="progress-bar">
            <div class="fill success" id="progressBar" style="width: 0%"></div>
        </div>

        <div class="summary">
            <div class="stat-card total">
                <div class="value" id="totalCount">0</div>
                <div class="label">总计</div>
            </div>
            <div class="stat-card passed">
                <div class="value" id="passedCount">0</div>
                <div class="label">通过</div>
            </div>
            <div class="stat-card failed">
                <div class="value" id="failedCount">0</div>
                <div class="label">失败</div>
            </div>
            <div class="stat-card skipped">
                <div class="value" id="skippedCount">0</div>
                <div class="label">跳过</div>
            </div>
            <div class="stat-card time">
                <div class="value" id="totalTime">0ms</div>
                <div class="label">耗时</div>
            </div>
        </div>

        <div id="suiteContainer"></div>

        <div class="console-output">
            <h3>控制台输出</h3>
            <pre id="consoleOutput"></pre>
        </div>

        <footer>
            <p>艹，这测试框架真TM好用 - 老王团队出品</p>
        </footer>
    </div>

    <!-- 加载Mock -->
    <script src="mocks/wps-mock.js"></script>

    <!-- 测试运行器核心 -->
    <script>
        /**
         * 测试运行器 - 陈十三的简易测试框架
         * 不需要什么Jest、Mocha，老子自己写一个更牛逼的
         */
        var TestRunner = (function() {
            'use strict';

            var suites = [];
            var results = {
                total: 0,
                passed: 0,
                failed: 0,
                skipped: 0,
                startTime: null,
                endTime: null
            };
            var consoleBuffer = [];

            /**
             * 注册测试套件
             */
            function registerSuite(suite) {
                suites.push(suite);
                console.log('[TestRunner] 注册测试套件: ' + suite.name);
            }

            /**
             * 断言函数
             */
            function assert(condition, message) {
                if (!condition) {
                    throw new Error(message || '断言失败');
                }
            }

            /**
             * 跳过测试
             */
            function skip(reason) {
                throw { skip: true, reason: reason || '测试跳过' };
            }

            /**
             * 运行单个测试
             */
            function runTest(suite, testName) {
                var startTime = Date.now();

                try {
                    // beforeEach
                    if (typeof suite.beforeEach === 'function') {
                        suite.beforeEach();
                    }

                    // 运行测试
                    suite[testName]();

                    // afterEach
                    if (typeof suite.afterEach === 'function') {
                        suite.afterEach();
                    }

                    return {
                        name: testName,
                        status: 'passed',
                        time: Date.now() - startTime
                    };
                } catch (err) {
                    if (err.skip) {
                        return {
                            name: testName,
                            status: 'skipped',
                            reason: err.reason,
                            time: Date.now() - startTime
                        };
                    }

                    return {
                        name: testName,
                        status: 'failed',
                        error: err.message || String(err),
                        time: Date.now() - startTime
                    };
                }
            }

            /**
             * 获取套件中的所有测试方法
             */
            function getTestMethods(suite) {
                var methods = [];
                for (var key in suite) {
                    if (key.indexOf('test') === 0 && typeof suite[key] === 'function') {
                        methods.push(key);
                    }
                }
                return methods;
            }

            /**
             * 运行指定套件
             */
            function runSuite(suiteName) {
                var suite = suites.find(function(s) {
                    return s.name.indexOf(suiteName) !== -1;
                });

                if (!suite) {
                    logConsole('error', '未找到测试套件: ' + suiteName);
                    return;
                }

                reset();
                runSuiteInternal(suite);
                updateUI();
            }

            /**
             * 内部运行套件
             */
            function runSuiteInternal(suite) {
                var tests = getTestMethods(suite);
                var suiteResults = [];

                logConsole('info', '开始运行测试套件: ' + suite.name);

                tests.forEach(function(testName) {
                    var result = runTest(suite, testName);
                    suiteResults.push(result);

                    results.total++;
                    if (result.status === 'passed') {
                        results.passed++;
                        logConsole('info', '  ✓ ' + testName + ' (' + result.time + 'ms)');
                    } else if (result.status === 'failed') {
                        results.failed++;
                        logConsole('error', '  ✗ ' + testName + ': ' + result.error);
                    } else {
                        results.skipped++;
                        logConsole('warn', '  ○ ' + testName + ': ' + result.reason);
                    }
                });

                return {
                    name: suite.name,
                    results: suiteResults
                };
            }

            /**
             * 运行所有测试
             */
            function runAll() {
                reset();
                results.startTime = Date.now();

                var allResults = [];

                suites.forEach(function(suite) {
                    var suiteResult = runSuiteInternal(suite);
                    allResults.push(suiteResult);
                });

                results.endTime = Date.now();

                updateUI(allResults);

                logConsole('info', '');
                logConsole('info', '====== 测试完成 ======');
                logConsole('info', '总计: ' + results.total + ', 通过: ' + results.passed +
                    ', 失败: ' + results.failed + ', 跳过: ' + results.skipped);
                logConsole('info', '耗时: ' + (results.endTime - results.startTime) + 'ms');
            }

            /**
             * 重置测试状态
             */
            function reset() {
                results = {
                    total: 0,
                    passed: 0,
                    failed: 0,
                    skipped: 0,
                    startTime: null,
                    endTime: null
                };
                consoleBuffer = [];
                document.getElementById('consoleOutput').textContent = '';
                document.getElementById('suiteContainer').innerHTML = '';
                updateStats();
            }

            /**
             * 日志输出
             */
            function logConsole(level, message) {
                consoleBuffer.push({ level: level, message: message });

                var output = document.getElementById('consoleOutput');
                var span = document.createElement('span');
                span.className = 'log-' + level;
                span.textContent = message + '\n';
                output.appendChild(span);
                output.scrollTop = output.scrollHeight;
            }

            /**
             * 更新统计数据
             */
            function updateStats() {
                document.getElementById('totalCount').textContent = results.total;
                document.getElementById('passedCount').textContent = results.passed;
                document.getElementById('failedCount').textContent = results.failed;
                document.getElementById('skippedCount').textContent = results.skipped;

                var time = results.endTime && results.startTime ?
                    (results.endTime - results.startTime) : 0;
                document.getElementById('totalTime').textContent = time + 'ms';

                var progress = results.total > 0 ?
                    Math.round((results.passed / results.total) * 100) : 0;
                var progressBar = document.getElementById('progressBar');
                progressBar.style.width = progress + '%';
                progressBar.className = 'fill ' + (results.failed > 0 ? 'failure' : 'success');
            }

            /**
             * 更新UI
             */
            function updateUI(allResults) {
                updateStats();

                if (!allResults) return;

                var container = document.getElementById('suiteContainer');
                container.innerHTML = '';

                allResults.forEach(function(suite) {
                    var passedCount = suite.results.filter(function(r) { return r.status === 'passed'; }).length;
                    var failedCount = suite.results.filter(function(r) { return r.status === 'failed'; }).length;

                    var suiteDiv = document.createElement('div');
                    suiteDiv.className = 'suite' + (failedCount > 0 ? ' expanded' : '');

                    suiteDiv.innerHTML = '<div class="suite-header" onclick="this.parentElement.classList.toggle(\'expanded\')">' +
                        '<h3>' + suite.name + '</h3>' +
                        '<div class="suite-stats">' +
                        '<span class="passed">' + passedCount + ' 通过</span>' +
                        '<span class="failed">' + failedCount + ' 失败</span>' +
                        '</div></div>' +
                        '<div class="suite-content"></div>';

                    var content = suiteDiv.querySelector('.suite-content');

                    suite.results.forEach(function(test) {
                        var testDiv = document.createElement('div');
                        testDiv.className = 'test-item ' + test.status;

                        var icon = test.status === 'passed' ? '✓' :
                                   test.status === 'failed' ? '✗' : '○';

                        var html = '<div class="icon">' + icon + '</div>' +
                            '<div class="name">' + test.name + '</div>' +
                            '<div class="time">' + test.time + 'ms</div>';

                        if (test.error) {
                            html += '<div class="error">' + test.error + '</div>';
                        }

                        testDiv.innerHTML = html;
                        content.appendChild(testDiv);
                    });

                    container.appendChild(suiteDiv);
                });
            }

            return {
                registerSuite: registerSuite,
                assert: assert,
                skip: skip,
                runAll: runAll,
                runSuite: runSuite,
                reset: reset
            };
        })();

        // 让全局可以访问
        window.TestRunner = TestRunner;
    </script>

    <!-- 加载处理器（需要确保路径正确） -->
    <script>
        // 模拟加载处理器 - 在实际环境中会从../js/handlers/目录加载
        // 这里我们创建简化版本来演示测试框架

        // 如果真正的处理器存在，就不需要这些模拟
        if (typeof ExcelHandler === 'undefined') {
            var excelLogger = new Logger('ExcelHandler');

            window.ExcelHandler = {
                getContext: function() {
                    var startTime = Date.now();
                    try {
                        var workbook = Application.ActiveWorkbook;
                        if (!workbook) {
                            return Response.error('DOCUMENT_NOT_FOUND', null, startTime, {
                                message: '请先打开一个Excel工作簿'
                            });
                        }

                        var sheetsList = [];
                        var sheetsCount = workbook.Sheets.Count;
                        for (var i = 1; i <= sheetsCount; i++) {
                            var sheet = workbook.Sheets.Item(i);
                            sheetsList.push({
                                index: i,
                                name: sheet.Name,
                                visible: sheet.Visible
                            });
                        }

                        var selection = null;
                        try {
                            var sel = Application.Selection;
                            if (sel) {
                                selection = {
                                    address: sel.Address(),
                                    rowCount: sel.Rows.Count,
                                    columnCount: sel.Columns.Count,
                                    value: sel.Value2,
                                    formula: sel.Formula
                                };
                            }
                        } catch (e) {}

                        var usedRange = null;
                        try {
                            var used = workbook.ActiveSheet.UsedRange;
                            if (used) {
                                usedRange = {
                                    address: used.Address(),
                                    rowCount: used.Rows.Count,
                                    columnCount: used.Columns.Count
                                };
                            }
                        } catch (e) {}

                        return Response.success({
                            workbook: {
                                name: workbook.Name,
                                path: workbook.Path,
                                saved: workbook.Saved
                            },
                            activeSheet: {
                                name: workbook.ActiveSheet.Name,
                                index: workbook.ActiveSheet.Index
                            },
                            sheets: sheetsList,
                            selection: selection,
                            usedRange: usedRange,
                            headers: []
                        }, null, startTime);
                    } catch (err) {
                        return Response.fromException(err, null, startTime);
                    }
                },

                setFormula: function(params) {
                    var startTime = Date.now();
                    var validation = Validator.checkRequired(params, ['range', 'formula']);
                    if (!validation.valid) {
                        return Response.error('PARAM_MISSING', null, startTime, {
                            missing: validation.missing
                        });
                    }

                    if (!Validator.isValidFormula(params.formula)) {
                        return Response.error('PARAM_FORMULA_INVALID', null, startTime, {
                            formula: params.formula
                        });
                    }

                    var workbook = Application.ActiveWorkbook;
                    if (!workbook) {
                        return Response.error('DOCUMENT_NOT_FOUND', null, startTime);
                    }

                    return Response.success({ range: params.range, formula: params.formula }, null, startTime);
                },

                _columnToLetter: function(column) {
                    var temp, letter = '';
                    while (column > 0) {
                        temp = (column - 1) % 26;
                        letter = String.fromCharCode(temp + 65) + letter;
                        column = (column - temp - 1) / 26;
                    }
                    return letter;
                }
            };
        }

        if (typeof WordHandler === 'undefined') {
            var wordLogger = new Logger('WordHandler');

            window.WordHandler = {
                getContext: function() {
                    var startTime = Date.now();
                    try {
                        var doc = Application.ActiveDocument;
                        if (!doc) {
                            return Response.error('DOCUMENT_NOT_FOUND', null, startTime, {
                                message: '请先打开一个Word文档'
                            });
                        }

                        return Response.success({
                            document: {
                                name: doc.Name,
                                path: doc.Path,
                                saved: doc.Saved
                            },
                            paragraphCount: doc.Paragraphs.Count,
                            wordCount: {
                                words: doc.ComputeStatistics(0),
                                characters: doc.ComputeStatistics(3),
                                pages: doc.ComputeStatistics(2)
                            },
                            structure: []
                        }, null, startTime);
                    } catch (err) {
                        return Response.fromException(err, null, startTime);
                    }
                },

                insertText: function(params) {
                    var startTime = Date.now();
                    var validation = Validator.checkRequired(params, ['text']);
                    if (!validation.valid) {
                        return Response.error('PARAM_MISSING', null, startTime, {
                            missing: validation.missing
                        });
                    }

                    var doc = Application.ActiveDocument;
                    if (!doc) {
                        return Response.error('DOCUMENT_NOT_FOUND', null, startTime);
                    }

                    return Response.success({ inserted: true }, null, startTime);
                },

                applyStyle: function(params) {
                    return Response.success({ applied: true }, null, Date.now());
                },

                setFont: function(params) {
                    return Response.success({ set: true }, null, Date.now());
                },

                findReplace: function(params) {
                    var startTime = Date.now();
                    var validation = Validator.checkRequired(params, ['find', 'replace']);
                    if (!validation.valid) {
                        return Response.error('PARAM_MISSING', null, startTime, {
                            missing: validation.missing
                        });
                    }
                    return Response.success({ replacedCount: 5 }, null, startTime);
                }
            };
        }

        if (typeof PPTHandler === 'undefined') {
            var pptLogger = new Logger('PPTHandler');

            window.PPTHandler = {
                getContext: function() {
                    var startTime = Date.now();
                    try {
                        var presentation = Application.ActivePresentation;
                        if (!presentation) {
                            return Response.error('DOCUMENT_NOT_FOUND', null, startTime, {
                                message: '请先打开一个PPT演示文稿'
                            });
                        }

                        return Response.success({
                            presentation: {
                                name: presentation.Name,
                                path: presentation.Path,
                                saved: presentation.Saved
                            },
                            slidesCount: presentation.Slides.Count,
                            currentSlide: {
                                index: 1
                            }
                        }, null, startTime);
                    } catch (err) {
                        return Response.fromException(err, null, startTime);
                    }
                },

                addSlide: function(params) {
                    var startTime = Date.now();
                    var presentation = Application.ActivePresentation;
                    if (!presentation) {
                        return Response.error('DOCUMENT_NOT_FOUND', null, startTime);
                    }
                    return Response.success({ added: true }, null, startTime);
                },

                addTextbox: function(params) {
                    var startTime = Date.now();
                    var validation = Validator.checkRequired(params, ['text']);
                    if (!validation.valid) {
                        return Response.error('PARAM_MISSING', null, startTime, {
                            missing: validation.missing
                        });
                    }
                    return Response.success({ added: true }, null, startTime);
                },

                beautifySlide: function(params) {
                    return Response.success({ beautified: true }, null, Date.now());
                },

                setSlideBackground: function(params) {
                    return Response.success({ set: true }, null, Date.now());
                },

                goToSlide: function(params) {
                    var startTime = Date.now();
                    var index = params.index;
                    var presentation = Application.ActivePresentation;

                    if (!presentation) {
                        return Response.error('DOCUMENT_NOT_FOUND', null, startTime);
                    }

                    if (index < 1 || index > presentation.Slides.Count) {
                        return Response.error('INVALID_INDEX', null, startTime, {
                            message: '幻灯片索引超出范围'
                        });
                    }

                    return Response.success({ index: index }, null, startTime);
                },

                deleteSlide: function(params) {
                    return Response.success({ deleted: true }, null, Date.now());
                }
            };
        }
    </script>

    <!-- 加载测试文件 -->
    <script src="unit/excel-handler.test.js"></script>
    <script src="unit/word-handler.test.js"></script>
    <script src="unit/ppt-handler.test.js"></script>

    <!-- 初始化 -->
    <script>
        console.log('测试运行器初始化完成');
        console.log('已注册的测试套件数量:', Object.keys(window).filter(function(k) {
            return k.indexOf('Tests') !== -1;
        }).length);
    </script>
</body>
</html>
